global
    log stdout format raw local0
    maxconn 20480

defaults
    log     global
    mode    tcp
    option  dontlognull
    timeout connect 5s
    timeout client  1m
    timeout server  1m

# TLS SNI split on single IP:443
frontend ft_tls
    bind *:443
    tcp-request inspect-delay 5s
    tcp-request content accept if { req.ssl_hello_type 1 }

    # Route to Caddy when SNI matches API domain
    acl api_sni req.ssl_sni -i api.example.com
    use_backend bk_caddy if api_sni
    default_backend bk_xray

backend bk_caddy
    mode tcp
    server caddy caddy:443 check

backend bk_xray
    mode tcp
    server xray xray:443 check

# HTTP 80 â†’ Caddy for ACME HTTP-01 and redirects
frontend ft_http
    bind *:80
    mode http
    default_backend bk_caddy_http

backend bk_caddy_http
    mode http
    server caddy caddy:80 check

